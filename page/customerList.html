<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    <script src="../js/mui.min.js"></script>
    <script src="../js/mui.tpl.min.js"></script>
</head>
<body>
	<div id="J_ScrollWrapper" class="mui-content mui-scroll-wrapper">
		<div class="mui-scroll">
			<ul id="J_List" class="mui-table-view mui-table-view-chevron"></ul>
		</div>
	</div>
<script type="text/x-handlebars-template" id="J_Tpl">
{{#each data}}
<li class="mui-table-view-cell">
	<a class="mui-navigate-right" href="#" data-id="{{_id}}">
		<span class="mui-badge mui-badge-success">{{no}}</span>
		<h5 class="mui-pull-left">{{name}}</h5>
		<strong class="mui-badge-primary">{{mobile}}</strong>
	</a>
</li>
{{/each}}
</script>
<script>
(function(win) {
var Page = {
	container: '#J_ScrollWrapper',
	sortData: {
		sort: {
			created: -1
		}
	},
	attach: function() {
		this.$list.on('tap', 'a', function() {
			var id = this.getAttribute('data-id');
			mui.fire(mui.currentWebview.parent(), 'openDetail', Page.customers.filter(function(item) { return item._id === id; })[0]);
			return false;
		});
		win.addEventListener('Customer:update', function(e) {
			var data = e.detail;
			var id = data._id;
			if (!id) {
				// add
				T.post('customer', { content: data }, function() {
					Page.refresh();
				});
			} else {
				// update
				delete data._id;
				T.put('customer', {
					id: id,
					content: data
				}, function() {
					mui.toast('更新成功');
				});
				data._id = id;
				Page.customers.forEach(function(item, i) {
					if (item._id === id) {
						Page.customers[i] = data;
					}
				});
				
				Page.$list.find('[data-id=' + id + ']').replaceWith(Page.tpl(data));
				T.setItemJSON(T.KEY_CUSTOMER, Page.customers);
			}
		});
	},
	
	ready: function() {
		var customers = plus.storage.getItem(T.KEY_CUSTOMER);
		if (!customers) {
			T.get('customer', this.sortData, function(data) {
				Page.customers = data;
				if (data.length < 1) {
					Page.$list.append('<li>您还没有顾客数据，请先增加</li>');
				} else {
					Page.append();
				}
			});
		} else {
			if (!this.customers || this.customers.length === 0) {
				this.$list.empty();
			}
			this.customers = JSON.parse(customers);
			this.append();
		}
	},
	
	append: function(data) {
		data = data || this.customers || [];
		if (data.length < 1) {
			return;
		}
		this.$list.append(this.tpl({data: data}));
	},
	
	refresh: function(callback) {
		T.get('customer', {
			content: mui.extend({
				query: {
					created: {
						$gt: Page.customers ? Page.customers[0].created || 0 : 0
					}
				}
			}, Page.sortData)
		}, function(data) {
			if (data.length > 0) {
				Page.customers = data.concat(Page.customers || []);
				Page.$list.empty();
				Page.append();
				// update localstorage
				T.setItemJSON(T.KEY_CUSTOMER, Page.customers);
			} else {
				mui.alert(Page.customers && Page.customers.length ? '已经是最新的了' : '您还没有顾客数据，请先增加');
			}
			callback && callback(data);
		});
	},
	
	init: function() {
		this.$list = $('#J_List');
		this.tpl = Handlebars.compile($('#J_Tpl').html());
		this.attach();
		
		mui.plusReady(this.ready.bind(this));
		
		mui.init({
			pullRefresh: {
				container: this.container,
				down: {
					callback: function() {
						Page.refresh(function() {
							mui(Page.container).pullRefresh().endPulldownToRefresh();
						});
					}
				}
			}
		});
	}
};

Page.init();
})(window);
</script>
</body>
</html>